<div id="investment-calculator" style="max-width:600px; font-family: Lucida, sans-unicode;">
  <h3>Lending Model Calculator</h3>

  <form id="investmentForm" style="margin-bottom:1rem;">
    <label for="investmentAmount">Initial Loan Amount ($):</label><br/>
    <input type="number" id="investmentAmount" name="investmentAmount" min="30000" required
      style="width:30%; padding:0.4rem; font-size:1rem; margin-top:0.25rem;"/><br/>
    <small>Minimum loan: $30,000</small><br/><br/>

    <label>Annual Rate of Return (%): </label><strong>12% fixed</strong><br/><br/>

    <button type="submit" 
      style="background:#233551;color:#fff;padding:0.5rem 1rem;border:none;border-radius:3px;cursor:pointer;">Calculate</button>
  </form>

  <div id="results" style="display:none; padding:1rem; border:1px solid #ddd; border-radius:5px; background:#fafafa;">
    <p><strong>Monthly Earnings:</strong> $<span id="monthlyPayment">0.00</span></p>

    <h4>5-Year Earnings Breakdown</h4> 
    <table border="1" cellpadding="5" cellspacing="0" style="border-collapse:collapse; width:100%; text-align:right;">
      <thead>
        <tr style="background:#233551; color:#fff;">
          <th style="text-align:center;">Year</th>
          <th>Principal</th>
          <th>Interest</th>
          <th>Total Earnings</th>
        </tr>
      </thead>
      <tbody id="yearlyBreakdown"></tbody>
    </table>

    <p><strong>When Can I Roll Earnings Into A New $30,000 Loan:</strong> <span id="rollMonths">0</span></p>

    <canvas id="earningsChart" width="600" height="300" 
      style="margin-top:1rem; background:#fff; border:1px solid #ddd; border-radius:5px;"></canvas>

    <!-- Media query to hide chart on mobile -->
    <style>
      @media screen and (max-width: 599px) {
        #earningsChart {
          display: none !important;
        }
      }
    </style>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  (function(){
    const form = document.getElementById('investmentForm');
    const resultsDiv = document.getElementById('results');
    const monthlyPaymentEl = document.getElementById('monthlyPayment');
    const rollMonthsEl = document.getElementById('rollMonths');
    const yearlyBreakdownBody = document.getElementById('yearlyBreakdown');
    const ctx = document.getElementById('earningsChart').getContext('2d');

    let chart;

    // Format number as USD currency string
    function formatUSD(num) {
      return num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // PMT-like formula for fixed monthly payment
    function calculateMonthlyPayment(rate, nper, pv) {
      if(rate === 0) return pv / nper;
      return (rate * pv) / (1 - Math.pow(1 + rate, -nper));
    }

    form.addEventListener('submit', function(e){
      e.preventDefault();

      const principal = parseFloat(form.investmentAmount.value);
      const annualRate = 0.12;
      const totalMonths = 60;
      const monthlyRate = annualRate / 12;

      if(isNaN(principal) || principal < 30000){
        alert('Initial investment must be at least $30,000.');
        resultsDiv.style.display = 'none';
        return;
      }

      const monthlyPayment = calculateMonthlyPayment(monthlyRate, totalMonths, principal);

      let remainingPrincipal = principal;
      const monthlyPrincipalReturned = [];
      const monthlyProfit = [];

      for(let month=1; month <= totalMonths; month++){
        const profitThisMonth = remainingPrincipal * monthlyRate;
        let principalReturn = monthlyPayment - profitThisMonth;
        if(principalReturn > remainingPrincipal) principalReturn = remainingPrincipal;

        monthlyProfit.push(profitThisMonth);
        monthlyPrincipalReturned.push(principalReturn);

        remainingPrincipal -= principalReturn;
        if(remainingPrincipal < 0) remainingPrincipal = 0;
      }

      monthlyPaymentEl.textContent = formatUSD(monthlyPayment);

      // Yearly aggregates
      const yearlyPrincipal = [];
      const yearlyProfit = [];
      const yearlyTotal = [];

      for(let year=0; year < 5; year++){
        let sumPrincipal = 0;
        let sumProfit = 0;
        for(let m=0; m<12; m++){
          sumPrincipal += monthlyPrincipalReturned[year*12 + m];
          sumProfit += monthlyProfit[year*12 + m];
        }
        yearlyPrincipal.push(sumPrincipal);
        yearlyProfit.push(sumProfit);
        yearlyTotal.push(sumPrincipal + sumProfit);
      }

      // Display yearly breakdown table
      yearlyBreakdownBody.innerHTML = '';
      for(let y=0; y<5; y++){
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="text-align:center;">${y+1}</td>
          <td>$${formatUSD(yearlyPrincipal[y])}</td>
          <td>$${formatUSD(yearlyProfit[y])}</td>
          <td>$${formatUSD(yearlyTotal[y])}</td>
        `;
        yearlyBreakdownBody.appendChild(row);
      }

      // Add total row
      const totalPrincipal = yearlyPrincipal.reduce((a,b) => a+b, 0);
      const totalProfit = yearlyProfit.reduce((a,b) => a+b, 0);
      const totalEarnings = yearlyTotal.reduce((a,b) => a+b, 0);

      const totalRow = document.createElement('tr');
      totalRow.style.fontWeight = 'bold';
      totalRow.style.backgroundColor = '#f1f1f1';
      totalRow.innerHTML = `
        <td style="text-align:center;">Total</td>
        <td>$${formatUSD(totalPrincipal)}</td>
        <td>$${formatUSD(totalProfit)}</td>
        <td>$${formatUSD(totalEarnings)}</td>
      `;
      yearlyBreakdownBody.appendChild(totalRow);

      // Calculate months to roll into new investment
      const monthsToRoll = Math.ceil(30000 / monthlyPayment);
      rollMonthsEl.textContent = `Month ${monthsToRoll}`;

      resultsDiv.style.display = 'block';

      // Calculate cumulative total earnings array
      const cumulativeTotalEarnings = [];
      let runningTotal = 0;
      for(let i=0; i < totalMonths; i++){
        runningTotal += monthlyPrincipalReturned[i] + monthlyProfit[i];
        cumulativeTotalEarnings.push(runningTotal);
      }

      const labels = Array.from({length: totalMonths}, (_,i) => i+1);

      if(chart) chart.destroy();

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Cumulative Total Earnings ($)',
            data: cumulativeTotalEarnings,
            borderColor: 'rgba(75, 192, 192, 0.9)',
            backgroundColor: 'rgba(75, 192, 192, 0.4)',
            fill: true,
            tension: 0.3,
            pointRadius: 2,
          }]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'nearest',
            intersect: false
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Month'
              }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Total Earnings ($)'
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'Cumulative Total Earnings Over 5 Years'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            },
            legend: {
              position: 'top'
            }
          }
        }
      });

    });
  })();
  </script>
</div>